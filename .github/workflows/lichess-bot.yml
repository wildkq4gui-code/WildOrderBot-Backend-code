name: Lichess Bot Scheduled Run

# Runs daily at 13:00 UTC (which is 07:00 CST when CST = UTC-6).
# GitHub Actions cron schedules use UTC. If your target timezone observes DST
# (e.g., switches to CDT = UTC-5), adjust the cron accordingly or add two
# schedules (one for standard time, one for daylight time).

on:
  schedule:
    # Run at 12:00 UTC every day -> 06:00 CST (America/Chicago, UTC-6)
    # Cron day-of-week: 0=Sunday, 1=Monday, 2=Tuesday, 3=Wednesday, 4=Thursday, 5=Friday, 6=Saturday
    - cron: '0 12 * * *'
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      LICHESS_TOKEN: ${{ secrets.LICHESS_TOKEN }}
      STOCKFISH_URL: ${{ secrets.STOCKFISH_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies (best-effort)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "LichessStockfishand-fairy-fish-1/pyproject.toml" ]; then pip install -e LichessStockfishand-fairy-fish-1 || true; fi

      - name: Download and install Stockfish 17 (optional)
        # This step will use either `STOCKFISH_PATH` if provided (path on the runner),
        # or `STOCKFISH_URL` secret to download a prebuilt binary/archive.
        run: |
          set -e
          mkdir -p LichessStockfishand-fairy-fish-1/stockfish

          if [ -n "$STOCKFISH_PATH" ] && [ -f "$STOCKFISH_PATH" ]; then
            echo "Using provided STOCKFISH_PATH: $STOCKFISH_PATH"
            cp "$STOCKFISH_PATH" LichessStockfishand-fairy-fish-1/stockfish/stockfish-17
            chmod +x LichessStockfishand-fairy-fish-1/stockfish/stockfish-17
          elif [ -n "$STOCKFISH_URL" ]; then
            echo "Downloading Stockfish from $STOCKFISH_URL"
            tmpf=/tmp/stockfish_download
            curl -fL "$STOCKFISH_URL" -o "$tmpf"
            file "$tmpf" || true

            if file "$tmpf" | grep -qi gzip; then
              tar -xzf "$tmpf" -C LichessStockfishand-fairy-fish-1/stockfish || true
            elif file "$tmpf" | grep -qi zip; then
              unzip -o "$tmpf" -d LichessStockfishand-fairy-fish-1/stockfish || true
            else
              # assume it's a single binary
              mv "$tmpf" LichessStockfishand-fairy-fish-1/stockfish/stockfish-17
            fi

            # Find an executable named stockfish* or any executable
            bin=$(find LichessStockfishand-fairy-fish-1/stockfish -type f -name 'stockfish*' -perm /111 | head -n1 || true)
            if [ -z "$bin" ]; then
              bin=$(find LichessStockfishand-fairy-fish-1/stockfish -type f -perm /111 | head -n1 || true)
            fi
            if [ -n "$bin" ]; then
              cp "$bin" LichessStockfishand-fairy-fish-1/stockfish/stockfish-17
              chmod +x LichessStockfishand-fairy-fish-1/stockfish/stockfish-17
              echo "Installed stockfish from $bin"
            else
              echo "No executable found after extracting download"
            fi
          else
            echo "No STOCKFISH_PATH or STOCKFISH_URL provided; skipping download"
          fi

          # Expose path to the runner
          echo "STOCKFISH_PATH=./LichessStockfishand-fairy-fish-1/stockfish/stockfish-17" >> $GITHUB_ENV


      - name: Run scheduled bot
        # The script expects `LICHESS_TOKEN` in the environment (set above from repo secret).
        run: |
          # Ensure the built stockfish binary is executable
          chmod +x LichessStockfishand-fairy-fish-1/stockfish/stockfish-ubuntu-x86-64-avx2 || true
          chmod +x LichessStockfishand-fairy-fish-1/stockfish/fairy-stockfish || true
          python3 LichessStockfishand-fairy-fish-1/run_scheduled.py
